@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewBag.Title = "Post Detail";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using ZAlpha.Application.Comment.Queries.GetComment;
@using ZAlpha.Application.Common.Models;
@using ZAlpha.Application.Post.Queries.GetAllPost;
@using ZAlpha.Application.Comment.Queries.GetAllComment;
@using ZAlpha.Domain.Enums;
@model PostModel;
@{
    PaginatedList<CommentModel> listComment = ViewBag.listComment;
}
<head>
    <link href="./assets/css/post-detail.css" rel="stylesheet" />
</head>

<div>


    <div class="box" style="min-height:600px;">
        <div class="row">
            <div class="col-6 box">
                <div>
                    <div style="position:relative ;">
                        <i id="bookmarkIcon" style="color: gray; position: absolute; top:10px; right:10px;" class="fa-solid fa-bookmark"></i>
                        @if (Model.WishListPosts?.FirstOrDefault(w => w.UserAccount.UserName == User.Identity.Name && w.IsDeleted == false) != null)
                        {
                            <i id="bookmarkIcon"
                               style="color: yellow; position: absolute; top:10px; right:10px;"
                               name="bookmarkIconPostId"
                               class="fa-solid fa-bookmark"
                               onclick="unWishlistPost('@Model.Id')">
                            </i>
                        }
                        else
                        {
                            <i id="bookmarkIcon"
                               style="color: gray; position: absolute; top:10px; right:10px;"
                               name="bookmarkIconPostId"
                               class="fa-solid fa-bookmark"
                               onclick="wishlistPost('@Model.Id')">
                            </i>
                        }
                        <br />
                    </div>
                    @foreach (var postTag in Model.PostTags)
                    {
                        <div class="textbox">
                            @postTag.Tag.TagName
                        </div>
                    }

                </div>
                <div class="TiltePost">
                    <strong>
                        @Model.PostTitle
                    </strong>
                </div>
                <div id="postSection" class="row">
                    <div class="col-2" style="display:flex;align-items: center;justify-content: center;">
                        <img style="width:3.6rem; height:3.6rem; border-radius: 9999px" src="https://via.placeholder.com/38x38" />
                    </div>
                    <div class="col-4">
                        <div style="color: black; font-size: 18px; font-family: Inter; font-weight: 500; word-wrap: break-word">
                            @{
                                string Name = null;
                            }
                            @foreach (var interactWithPosts in Model.InteractWithPosts)
                            {
                                if (interactWithPosts.InteractPostStatus == 0)
                                {
                                    Name = interactWithPosts.UserAccount.FirstName + " " + interactWithPosts.UserAccount.LastName;
                                    break;
                                }
                            }
                            @Name
                            @if (Model.EmotionalStatus != null && Model.EmotionalStatus != ZAlpha.Domain.Enums.EmotionalStatus.None)
                            {
                                <div style="font-size:14px;  color:#6d9da6;">
                                    đang cảm thấy @Model.EmotionalStatus.ToString()
                                </div>
                            }
                        </div>
                        <div style="color: #FF6C37; font-size: 13px; font-family: Inter; font-weight: 400; word-wrap: break-word">
                            @Model.Created
                        </div>
                    </div>
                    <div class="col-2"></div>
                        @if (ViewBag.interactedPostStatus != null)
                        {
                            if (ViewBag.interactedPostStatus == "Create")
                            {
                                <div class="col-2">
                                    <button id="btnPostLike" disabled class="button-2" style="height: 32px; width:5vw;" role="button"><i class="fa-solid fa-arrow-up"></i> @Model.InteractWithPosts.Where(i => i.InteractPostStatus == ZAlpha.Domain.Enums.InteractPostStatus.Like).Count() </button>
                                </div>
                                <div class="col-2">
                                    <button id="btnPostDislike" disabled class="button-62" style="height: 32px; width:5vw;" role="button"><i class="fa-solid fa-arrow-down"></i> @Model.InteractWithPosts.Where(i => i.InteractPostStatus == ZAlpha.Domain.Enums.InteractPostStatus.Dislike).Count() </button>
                                </div>
                            }
                            else if (ViewBag.interactedPostStatus == "Like")
                            {
                                <div class="col-2">
                                    <button id="btnPostLike" disabled class="button-2" style="height: 32px; width:5vw;" role="button"><i class="fa-solid fa-arrow-up"></i> @Model.InteractWithPosts.Where(i => i.InteractPostStatus == ZAlpha.Domain.Enums.InteractPostStatus.Like).Count() </button>
                                </div>
                                <div class="col-2">
                                    <button id="btnPostDislike" class="button-62" style="height: 32px; width:5vw;" role="button"><i class="fa-solid fa-arrow-down"></i> @Model.InteractWithPosts.Where(i => i.InteractPostStatus == ZAlpha.Domain.Enums.InteractPostStatus.Dislike).Count() </button>
                                </div>
                            }
                            else
                            {
                                <div class="col-2">
                                    <button id="btnPostLike" class="button-2" style="height: 32px; width:5vw;" role="button"><i class="fa-solid fa-arrow-up"></i> @Model.InteractWithPosts.Where(i => i.InteractPostStatus == ZAlpha.Domain.Enums.InteractPostStatus.Like).Count() </button>
                                </div>
                                <div class="col-2">
                                    <button id="btnPostDislike" disabled class="button-62" style="height: 32px; width:5vw;" role="button"><i class="fa-solid fa-arrow-down"></i> @Model.InteractWithPosts.Where(i => i.InteractPostStatus == ZAlpha.Domain.Enums.InteractPostStatus.Dislike).Count() </button>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="col-2">
                                <button id="btnPostLike" class="button-2" style="height: 32px; width:5vw;" role="button"><i class="fa-solid fa-arrow-up"></i> @Model.InteractWithPosts.Where(i => i.InteractPostStatus == ZAlpha.Domain.Enums.InteractPostStatus.Like).Count() </button>
                            </div>
                            <div class="col-2">
                                <button id="btnPostDislike" class="button-62" style="height: 32px; width:5vw;" role="button"><i class="fa-solid fa-arrow-down"></i> @Model.InteractWithPosts.Where(i => i.InteractPostStatus == ZAlpha.Domain.Enums.InteractPostStatus.Dislike).Count() </button>
                            </div>
                        }
                </div>

                <div class="ImgCenter">
                    <img class="" style="width: 33vw; border-radius: 10px;  justify-content:center;
                        align-content:center;
                        text-align:center;
                        margin:1rem;"
                         src="@Model.PostImagesUrl" />
                </div>

                <div class="row">
                    <div class="PostText">
                        @* <div class="hashtag">
                            <p>#hashtag</p>
                            <p>#hashtagtest</p>
                        </div> *@
                        @Model.PostBody
                    </div>
                </div>



            </div>
            @*--------------Comment-----------*@

            <div class="col-6">
                <div class="boxComment">
                    <div id="scroll" style=" overflow:auto;  display:flex; justify-content:center;">
                        <div style="width:90%;">
                            <div id="commentSection">
                                @await Html.PartialAsync("_CommentListPartial", listComment.Items)
                            </div>
                            @* @foreach (var item in listComment.Items)
                            {
                            <div style="row">
                            <div style="position:relative;">
                            <img style="width:35px;border-radius:50%; margin: 0.5vw 0px 0.2vw 0; " src="https://via.placeholder.com/35x35" />
                            <strong style="display:inline; font-size:12px;">@item.UserAccount.FirstName @item.UserAccount.LastName</strong>
                            <div style="color: #FF6C37; font-size: 11px; display:inline; position:absolute; right:2vw; bottom:2px;">
                            @item.Created
                            </div>
                            </div>
                            <div class="DivComment">
                            <div style="font-size:13px">
                            @item.Description
                            </div>
                            <div class="button-comment">
                            <div style="">
                            <button type="button" class="btn rounded-circle" style="background-color:#75d995; color:white;">
                            <p style="font-size:9px; margin:0;">3 <i class="fa-solid fa-arrow-up fa-xs"></i></p>
                            </button>
                            <button type="button" class="btn rounded-circle" style="background-color:#d97575; color:white;">
                            <p style="font-size:9px; margin:0;">9 <i class="fa-solid fa-arrow-down fa-xs"></i></p>
                            </button>
                            </div>
                            </div>
                            </div>
                            </div>
                            } *@




                            @*---------Div Comment--------*@
                            @* <div style="row">
                            <img style="width:35px;border-radius:50%; margin: 0.5vw 0px 0.2vw 0; " src="https://via.placeholder.com/35x35" />
                            <div class="DivComment">
                            <div style="font-size:13px">
                            Em chỉ đang cảm thấy mệt mỏi, quá tải và cần sẻ chia thôi. Anh luôn ở đây hỗ trợ em, bản chất em có những suy nghĩ trên đã là một điểm tích cực, là điều đáng quý. Hãy bắt đầu từ việc viết lại mục đích, lý do chọn lựa con đường của em, để lấy nó làm điểm tựa mỗi khi đối diện với cảm xúc khó chịu mà em đề cập. Còn nếu được hãy tham gia một buổi hẹn ngắn với anh nếu em vẫn cảm thấy struggle
                            </div>
                            <div class="button-comment">
                            <div style="">
                            <button type="button" class="btn btn-success rounded-circle"><i class="fa-solid fa-arrow-up"></i></button>
                            <button type="button" class="btn btn-warning rounded-circle"><i class="fa-solid fa-arrow-down"></i></button>
                            </div>
                            </div>
                            </div>
                            </div> *@

                        </div>
                    </div>
                    @* <form action="~/Post" method="post">
                    <div class="search">
                    <input type="hidden" name="PostId" value="@Model.Id" />
                    <input type="text" class="search__input" name="Description" placeholder="Type your text">
                    <button class="search__button" type="submit">
                    <i class="fa-solid fa-paper-plane fa-xl"></i>
                    </button>
                    </div>
                    </form> *@
                    <div class="search">
                        <input type="text" id="commentDescription" class="search__input" name="Description" placeholder="Type your text">
                        <button id="submitComment" class="search__button" type="submit">
                            <i class="fa-solid fa-paper-plane fa-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    //Hàm đăng bình luận
    document.getElementById("commentDescription").addEventListener("keypress", function (event) {
        if (event.key === "Enter" || event.keyCode === 13) {
            event.preventDefault();
            submitComment();
        }
    });
    $("#submitComment").click(function () {
        submitComment();
    });
    function submitComment() {
        var postId = "@Model.Id";
        var description = $("#commentDescription").val();
        
        $.ajax({
            type: "POST",
            url: "@Url.Action("AddComment", "Post")",
            data: { postId: postId, description: description },
            success: function (result) {
                if (result.success) {
                    // alert(result.message);
                    $("#commentSection").load("/Post/Index?postId=" + postId + " #commentSection");                    
                } else {
                    //alert(result.message);
                    window.location.href = '/login';
                }
            },
            error: function () {
                alert("Đã xảy ra lỗi khi gửi yêu cầu.");
            }
        });
    }
    // $(document).ready(function () {
    //     $("#submitComment").click(function () {
    //         var postId = "@Model.Id";
    //         var description = $("#commentDescription").val();

    //         $.ajax({
    //             type: "POST",
    //             url: "@Url.Action("AddComment", "Post")",
    //             data: { postId: postId, description: description },
    //             success: function (result) {
    //                 if (result.success) {
    //                     alert(result.message);
    //                     $("#commentSection").load("/Post/Index?postId=" + postId + " #commentSection");
    //                 } else {
    //                     alert(result.message);
    //                     window.location.href = '/login';
    //                 }
    //             },
    //             error: function () {
    //                 alert("Đã xảy ra lỗi khi gửi yêu cầu.");
    //             }
    //         });
    //     });
    // });

    //Hàm tương tác với bài viết
    $(document).on("click", "#btnPostLike", function () {
        likePost();
    });

    $(document).on("click", "#btnPostDislike", function () {
        dislikePost();
    });

    function likePost() {
        var postId = "@Model.Id";

        $.ajax({
            type: "POST",
            url: "@Url.Action("InteractWithPost", "Post")",
            data: { postId: postId, status: 1 },
            success: function (result) {
                if (result.success) {
                    //alert(result.message);
                    $("#postSection").load("/Post/Index?postId=" + postId + " #postSection");
                } else {
                    //alert(result.message);
                    window.location.href = '/login';
                }
            },
            error: function () {
                alert("Đã xảy ra lỗi khi gửi yêu cầu.");
            }
        });
    }
    function dislikePost() {
        var postId = "@Model.Id";

        $.ajax({
            type: "POST",
            url: "@Url.Action("InteractWithPost", "Post")",
            data: { postId: postId, status: 2 },
            success: function (result) {
                if (result.success) {
                    //alert(result.message);
                    $("#postSection").load("/Post/Index?postId=" + postId + " #postSection");
                } else {
                    //alert(result.message);
                    window.location.href = '/login';
                }
            },
            error: function () {
                alert("Đã xảy ra lỗi khi gửi yêu cầu.");
            }
        });
    }

    function wishlistPost(postId) {
        $.ajax({
            type: "POST",
            url: "@Url.Action("WishListPost", "Home")",
            data: { postId: postId, isDeleted: false },
            success: function (result) {
                if (result.success) {
                    //alert(result.message);
                    window.location.reload();
                } else {
                    //alert(result.message);
                    window.location.href = '/login';
                }
            },
            error: function () {
                alert("Đã xảy ra lỗi khi gửi yêu cầu.");
            }
        });
    }
    function unWishlistPost(postId) {
        $.ajax({
            type: "POST",
            url: "@Url.Action("WishListPost", "Home")",
            data: { postId: postId, isDeleted: true },
            success: function (result) {
                if (result.success) {
                    //alert(result.message);
                    window.location.reload();
                } else {
                    //alert(result.message);
                    window.location.href = '/login';
                }
            },
            error: function () {
                alert("Đã xảy ra lỗi khi gửi yêu cầu.");
            }
        });
    }
    
</script>